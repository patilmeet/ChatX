<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatRoom - Private Messaging</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-track { background: #1e293b; }
        .messages-container::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .message-bubble { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    
    <!-- Landing Screen -->
    <div id="landingScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800/80 backdrop-blur-xl rounded-3xl p-8 w-full max-w-md shadow-2xl border border-slate-700">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">ChatRoom</h1>
                <p class="text-slate-400">Private messaging with friends</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Your Nickname</label>
                    <input type="text" id="nicknameInput" placeholder="Enter your name" 
                        class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>

                <div class="pt-4 border-t border-slate-700">
                    <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Create New Room
                    </h3>
                    <div class="space-y-3">
                        <input type="text" id="newRoomName" placeholder="Room name" 
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                        <input type="password" id="newRoomPasscode" placeholder="Set passcode (min 4 chars)" 
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition">
                        <button onclick="createRoom()" 
                            class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-[1.02] active:scale-[0.98]">
                            Create Room
                        </button>
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-700">
                    <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        Join Existing Room
                    </h3>
                    <div class="space-y-3">
                        <input type="text" id="joinRoomId" placeholder="Room ID" 
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                        <input type="password" id="joinRoomPasscode" placeholder="Room passcode" 
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                        <button onclick="joinRoom()" 
                            class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-pink-700 transition transform hover:scale-[1.02] active:scale-[0.98]">
                            Join Room
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="min-h-screen flex flex-col hidden">
        <!-- Header -->
        <div class="bg-slate-800/90 backdrop-blur-xl border-b border-slate-700 px-4 py-3">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="leaveRoom()" class="p-2 hover:bg-slate-700 rounded-lg transition">
                        <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div>
                        <h2 id="roomTitle" class="text-white font-semibold">Room Name</h2>
                        <p id="roomIdDisplay" class="text-xs text-slate-400">Room ID: xxxxxx</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="onlineCount" class="flex items-center gap-1 bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <span>0 online</span>
                    </div>
                    <button onclick="copyRoomId()" class="p-2 hover:bg-slate-700 rounded-lg transition" title="Copy Room ID">
                        <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto messages-container p-4">
            <div id="messagesList" class="max-w-4xl mx-auto space-y-3">
                <!-- Messages will be inserted here -->
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden max-w-4xl mx-auto px-4 pb-2">
            <div class="flex items-center gap-2 text-slate-400 text-sm">
                <div class="typing-indicator flex gap-1">
                    <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                </div>
                <span id="typingText">Someone is typing...</span>
            </div>
        </div>

        <!-- Message Input -->
        <div class="bg-slate-800/90 backdrop-blur-xl border-t border-slate-700 p-4">
            <div class="max-w-4xl mx-auto flex gap-3">
                <input type="text" id="messageInput" placeholder="Type a message..." 
                    onkeypress="handleKeyPress(event)"
                    class="flex-1 px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                <button onclick="sendMessage()" 
                    class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-pink-700 transition transform hover:scale-[1.02] active:scale-[0.98]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXKMDFjUYFjvhHhD1-jJHMKaNSUVJGe5c",
            authDomain: "picshare-866e3.firebaseapp.com",
            databaseURL: "https://picshare-866e3-default-rtdb.firebaseio.com",
            projectId: "picshare-866e3",
            storageBucket: "picshare-866e3.firebasestorage.app",
            messagingSenderId: "360237752242",
            appId: "1:360237752242:web:2143497629817cc4cd0eab",
            measurementId: "G-60SCPVYL2D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // App State
        let currentUser = {
            id: 'user_' + Math.random().toString(36).substr(2, 9),
            nickname: ''
        };
        let currentRoom = null;
        let typingTimeout = null;
        let messagesRef = null;
        let presenceRef = null;
        let typingRef = null;

        // Generate Room ID
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        // Hash passcode (simple hash for demo)
        function hashPasscode(passcode) {
            let hash = 0;
            for (let i = 0; i < passcode.length; i++) {
                const char = passcode.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // Show Toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `fixed top-4 right-4 ${isError ? 'bg-red-600' : 'bg-green-600'} text-white px-6 py-3 rounded-xl shadow-lg transform transition-transform duration-300 z-50`;
            toast.style.transform = 'translateX(0)';
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
            }, 3000);
        }

        // Create Room
        function createRoom() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const roomName = document.getElementById('newRoomName').value.trim();
            const passcode = document.getElementById('newRoomPasscode').value.trim();

            if (!nickname) {
                showToast('Please enter your nickname', true);
                return;
            }
            if (!roomName) {
                showToast('Please enter a room name', true);
                return;
            }
            if (passcode.length < 4) {
                showToast('Passcode must be at least 4 characters', true);
                return;
            }

            currentUser.nickname = nickname;
            const roomId = generateRoomId();

            const roomData = {
                name: roomName,
                passcodeHash: hashPasscode(passcode),
                createdAt: Date.now(),
                createdBy: currentUser.nickname
            };

            database.ref('rooms/' + roomId).set(roomData).then(() => {
                showToast('Room created! Share the Room ID: ' + roomId);
                enterRoom(roomId, roomName);
            }).catch(error => {
                showToast('Error creating room: ' + error.message, true);
            });
        }

        // Join Room
        function joinRoom() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();
            const passcode = document.getElementById('joinRoomPasscode').value.trim();

            if (!nickname) {
                showToast('Please enter your nickname', true);
                return;
            }
            if (!roomId) {
                showToast('Please enter a room ID', true);
                return;
            }
            if (!passcode) {
                showToast('Please enter the room passcode', true);
                return;
            }

            currentUser.nickname = nickname;

            database.ref('rooms/' + roomId).once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    showToast('Room not found', true);
                    return;
                }

                const room = snapshot.val();
                if (room.passcodeHash !== hashPasscode(passcode)) {
                    showToast('Incorrect passcode', true);
                    return;
                }

                showToast('Joined room successfully!');
                enterRoom(roomId, room.name);
            }).catch(error => {
                showToast('Error joining room: ' + error.message, true);
            });
        }

        // Enter Room
        function enterRoom(roomId, roomName) {
            currentRoom = roomId;
            document.getElementById('landingScreen').classList.add('hidden');
            document.getElementById('chatScreen').classList.remove('hidden');
            document.getElementById('roomTitle').textContent = roomName;
            document.getElementById('roomIdDisplay').textContent = 'Room ID: ' + roomId;

            // Setup message listener
            messagesRef = database.ref('messages/' + roomId);
            messagesRef.orderByChild('timestamp').on('child_added', snapshot => {
                displayMessage(snapshot.val());
            });

            // Setup presence
            presenceRef = database.ref('presence/' + roomId + '/' + currentUser.id);
            presenceRef.set({
                nickname: currentUser.nickname,
                online: true,
                lastSeen: Date.now()
            });
            presenceRef.onDisconnect().remove();

            // Listen for presence changes
            database.ref('presence/' + roomId).on('value', snapshot => {
                const users = snapshot.val();
                const count = users ? Object.keys(users).length : 0;
                document.getElementById('onlineCount').querySelector('span:last-child').textContent = count + ' online';
            });

            // Setup typing indicator
            typingRef = database.ref('typing/' + roomId);
            typingRef.on('value', snapshot => {
                const typing = snapshot.val();
                if (typing) {
                    const typingUsers = Object.entries(typing)
                        .filter(([id, data]) => id !== currentUser.id && Date.now() - data.timestamp < 3000)
                        .map(([id, data]) => data.nickname);
                    
                    if (typingUsers.length > 0) {
                        document.getElementById('typingIndicator').classList.remove('hidden');
                        document.getElementById('typingText').textContent = 
                            typingUsers.length === 1 
                                ? typingUsers[0] + ' is typing...'
                                : typingUsers.join(', ') + ' are typing...';
                    } else {
                        document.getElementById('typingIndicator').classList.add('hidden');
                    }
                } else {
                    document.getElementById('typingIndicator').classList.add('hidden');
                }
            });

            // System message
            sendSystemMessage(currentUser.nickname + ' joined the room');

            // Focus input
            document.getElementById('messageInput').focus();
        }

        // Leave Room
        function leaveRoom() {
            if (currentRoom) {
                sendSystemMessage(currentUser.nickname + ' left the room');
                
                // Cleanup
                if (messagesRef) messagesRef.off();
                if (presenceRef) presenceRef.remove();
                if (typingRef) typingRef.off();
                database.ref('presence/' + currentRoom).off();
                database.ref('typing/' + currentRoom + '/' + currentUser.id).remove();

                currentRoom = null;
                document.getElementById('messagesList').innerHTML = '';
            }

            document.getElementById('chatScreen').classList.add('hidden');
            document.getElementById('landingScreen').classList.remove('hidden');
        }

        // Send Message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !currentRoom) return;

            const message = {
                id: 'msg_' + Date.now(),
                userId: currentUser.id,
                nickname: currentUser.nickname,
                text: text,
                timestamp: Date.now(),
                type: 'user'
            };

            database.ref('messages/' + currentRoom).push(message);
            database.ref('typing/' + currentRoom + '/' + currentUser.id).remove();
            input.value = '';
        }

        // Send System Message
        function sendSystemMessage(text) {
            const message = {
                id: 'sys_' + Date.now(),
                text: text,
                timestamp: Date.now(),
                type: 'system'
            };
            database.ref('messages/' + currentRoom).push(message);
        }

        // Display Message
        function displayMessage(message) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message-bubble';

            if (message.type === 'system') {
                div.innerHTML = `
                    <div class="text-center">
                        <span class="text-slate-500 text-sm bg-slate-800/50 px-4 py-1 rounded-full">
                            ${escapeHtml(message.text)}
                        </span>
                    </div>
                `;
            } else {
                const isOwn = message.userId === currentUser.id;
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                div.innerHTML = `
                    <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs sm:max-w-md lg:max-w-lg">
                            ${!isOwn ? `<p class="text-xs text-slate-400 mb-1 ml-1">${escapeHtml(message.nickname)}</p>` : ''}
                            <div class="${isOwn 
                                ? 'bg-gradient-to-r from-purple-500 to-pink-600 text-white' 
                                : 'bg-slate-700 text-white'} px-4 py-2 rounded-2xl ${isOwn ? 'rounded-br-md' : 'rounded-bl-md'}">
                                <p class="break-words">${escapeHtml(message.text)}</p>
                            </div>
                            <p class="text-xs text-slate-500 mt-1 ${isOwn ? 'text-right mr-1' : 'ml-1'}">${time}</p>
                        </div>
                    </div>
                `;
            }

            container.appendChild(div);
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        // Handle typing
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
                return;
            }

            // Update typing status
            if (currentRoom) {
                database.ref('typing/' + currentRoom + '/' + currentUser.id).set({
                    nickname: currentUser.nickname,
                    timestamp: Date.now()
                });

                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    database.ref('typing/' + currentRoom + '/' + currentUser.id).remove();
                }, 2000);
            }
        }

        // Copy Room ID
        function copyRoomId() {
            if (currentRoom) {
                navigator.clipboard.writeText(currentRoom).then(() => {
                    showToast('Room ID copied to clipboard!');
                });
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (presenceRef) presenceRef.remove();
        });
    </script>
</body>
</html>
